<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content" />
  <title>iWaffle</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" id="theme-color-meta" content="#FFFBF0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Babel for in-browser JSX/TSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
    if (localStorage.theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
  <style>
    :root {
      /* Core Palette */
      --color-cream: #FFFBF0;
      --color-butter-yellow: #FFD97D;
      --color-syrup-brown: #6B3E26;
      --color-strawberry-pink: #FF7E9D;
      --color-strawberry-pink-rgb: 255, 126, 157;
      --color-blueberry-purple: #6C63FF;
      --color-charcoal: #333333;

      /* Semantic Variables (Light) */
      --color-background: var(--color-cream);
      --color-text-primary: var(--color-charcoal);
      --color-text-secondary: #5a616d;
      --color-text-on-heading: var(--color-charcoal);
      --color-heading: var(--color-syrup-brown);
      --color-card-background: rgba(255, 255, 255, 0.7);
      --color-subtle-background: rgba(255, 246, 229, 0.7);
      --color-input-background: #FFFFFF;
      --color-border: rgba(107, 62, 38, 0.2);
      --color-button-inactive-bg: #E5E7EB;
      --color-button-inactive-text: var(--color-charcoal);

      --font-body: 'Poppins', sans-serif;
      --font-display: 'Pacifico', cursive;
    }

    html.dark {
      /* Semantic Variables (Dark) */
      --color-background: #1a202c;
      --color-text-primary: #E5E7EB;
      --color-text-secondary: #9CA3AF;
      --color-text-on-heading: #1a202c;
      --color-heading: var(--color-butter-yellow);
      --color-card-background: rgba(26, 32, 44, 0.7);
      --color-subtle-background: rgba(45, 55, 72, 0.5);
      --color-input-background: #2d3748;
      --color-border: rgba(255, 217, 125, 0.2);
      --color-button-inactive-bg: #374151;
      --color-button-inactive-text: var(--color-text-primary);
    }

    body {
      background-color: var(--color-background);
      color: var(--color-text-primary);
      font-family: var(--font-body);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .json-key { color: var(--color-blueberry-purple); }
    html.dark .json-key { color: #82aaff; }
    .json-string { color: var(--color-heading); }
    html.dark .json-string { color: #c3e88d; }
    .json-number { color: var(--color-strawberry-pink); }
    html.dark .json-number { color: #f78c6c; }
    .json-boolean { color: var(--color-strawberry-pink); }
    html.dark .json-boolean { color: #f78c6c; }
    .json-null { color: var(--color-text-secondary); }
    
    .typewriter-cursor {
      display: inline-block;
      width: 8px;
      height: 1.2em;
      background-color: var(--color-text-primary);
      animation: blink 0.7s infinite;
      margin-left: 2px;
      vertical-align-bottom;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    @keyframes pulse-mic {
        0% { box-shadow: 0 0 0 0 rgba(var(--color-strawberry-pink-rgb), 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(var(--color-strawberry-pink-rgb), 0); }
        100% { box-shadow: 0 0 0 0 rgba(var(--color-strawberry-pink-rgb), 0); }
    }
    .animate-pulse-mic { animation: pulse-mic 2s infinite; }
    @keyframes active-bounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-6px) scale(1.1); }
    }
    .animate-active-bounce { animation: active-bounce 1.2s infinite ease-in-out; }
    @keyframes waveform {
      0%, 100% { transform: scaleY(0.4); }
      50% { transform: scaleY(1); }
    }
    .animate-waveform { animation: waveform 1.2s ease-in-out infinite; }
    @keyframes jiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(5deg) scale(1.05); }
      75% { transform: rotate(-5deg) scale(1.05); }
    }
    .animate-jiggle { animation: jiggle 0.5s ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="importmap">
  {
    "imports": {
      "react": "https://aistudiocdn.com/react@^19.1.1",
      "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
      "react/": "https://aistudiocdn.com/react@^19.1.1/",
      "@google/genai": "https://aistudiocdn.com/@google/genai@^1.20.0"
    }
  }
  </script>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, Fragment, useCallback } from 'react';
    import ReactDOM from 'react-dom/client';
    import { GoogleGenAI, Type } from "@google/genai";

    //======= SERVICES =======//

    if (!process.env.API_KEY) {
      console.warn("API_KEY environment variable is not set. The application will not function without it.");
    }
    
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    const promptSchema = {
        type: Type.OBJECT,
        properties: {
            final_prompt: { type: Type.STRING, description: "The final, detailed, and expertly crafted system prompt." },
            best_practices_summary: { type: Type.STRING, description: "A summary of the prompt engineering best practices applied." },
        },
        required: ["final_prompt", "best_practices_summary"]
    };
    
    const generatePrompt = async (userWaffle, targetAI) => {
        try {
            const systemInstruction = `You are a world-class 'prompt chef' at iWaffle, an expert in crafting high-quality system prompts for large language models. Your unique skill is interpreting rambling, imprecise, and conversational user input â€“ what we call "waffling". Your task is to take a user's raw, unstructured thoughts and distill them into a detailed, effective, and professional prompt, specifically optimized for the target AI: ${targetAI}. Do not ask for clarification. Analyze the user's "waffle" to understand their core intent, the desired tone, format, and any underlying constraints. Your response must be a single JSON object conforming to the provided schema, containing the final prompt and a summary of the best practices you applied.`;
    
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: `User's Waffle: "${userWaffle}"`,
                config: { systemInstruction, responseMimeType: 'application/json', responseSchema: promptSchema }
            });
    
            const result = JSON.parse(response.text);
            return { type: 'success', content: { prompt: result.final_prompt, best_practices_summary: result.best_practices_summary, targetAI, metadata: { date: new Date().toISOString(), description: userWaffle } } };
    
        } catch (error) {
            console.error("Error in generatePrompt:", error);
            return { type: 'error', content: { error: true, message: "The prompt chef had trouble with this recipe.", suggestions: ["Try rephrasing your goal to be more specific.", "Ensure your goal is clearly stated."] } };
        }
    };

    //======= ICON COMPONENTS =======//
    const LogoIcon = (props) => ( <img src="https://i.imgur.com/d3TFFJr.png" alt="iWaffle Logo" {...props} /> );
    const MicrophoneIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" /> <path strokeLinecap="round" strokeLinejoin="round" d="M19 10v2a7 7 0 01-14 0v-2" /> <path strokeLinecap="round" strokeLinejoin="round" d="M12 19v3" /> </svg> );
    const MoonIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /> </svg> );
    const SparklesIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.456-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.197a3.375 3.375 0 002.456 2.456l1.197.398-1.197.398a3.375 3.375 0 00-2.456 2.456z" /> </svg> );
    const SunIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}> <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /> </svg> );
    const DownloadIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> );
    const HomeIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955a.75.75 0 011.06 0l8.955 8.955" /><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 21V11.25l5.25-5.25 5.25 5.25V21" /></svg> );

    //======= UI COMPONENTS =======//
    const ActionButton = ({ textToCopy, dataToDownload, className }) => {
        const [copied, setCopied] = useState(false);
        
        const handleCopy = () => {
            if (!textToCopy) return;
            navigator.clipboard.writeText(textToCopy).then(() => {
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            });
        };

        const handleDownload = () => {
            const jsonString = JSON.stringify(dataToDownload, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `iwaffle-prompt-${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const CopyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>);
        const CheckIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>);

        return (
            <div className={`flex items-center gap-2 ${className}`}>
                 <button onClick={handleDownload} className="flex items-center gap-2 font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow hover:-translate-y-0.5 bg-gray-500 text-white">
                    <DownloadIcon className="w-5 h-5" /> Download
                </button>
                <button onClick={handleCopy} className={`flex items-center gap-2 font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow hover:-translate-y-0.5 ${ copied ? 'bg-green-500' : 'bg-[--color-strawberry-pink]'} text-white`}>
                    {copied ? <CheckIcon/> : <CopyIcon/>}
                    {copied ? 'Copied!' : 'Copy Prompt'}
                </button>
            </div>
        );
    };

    const JsonDisplay = ({ jsonObject, title }) => {
      const jsonString = JSON.stringify(jsonObject, null, 2);

      const syntaxHighlight = (json) => {
          json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return json.replace(/("(\\u[a-zA-Z0.9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
              let cls = 'json-number';
              if (/^"/.test(match)) { cls = /:$/.test(match) ? 'json-key' : 'json-string'; }
              else if (/true|false/.test(match)) { cls = 'json-boolean'; }
              else if (/null/.test(match)) { cls = 'json-null'; }
              return '<span class="' + cls + '">' + match + '</span>';
          });
      }
      return (
        <div className="rounded-lg overflow-hidden my-4 border-2" style={{ borderColor: 'var(--color-border)' }}>
          <div className="px-4 py-2" style={{ backgroundColor: 'var(--color-subtle-background)'}}>
            <h3 className="text-sm font-bold" style={{ color: 'var(--color-text-secondary)'}}>{title}</h3>
          </div>
          <pre className="p-4 text-sm overflow-x-auto" style={{ backgroundColor: 'var(--color-input-background)', color: 'var(--color-text-primary)'}}>
            <code dangerouslySetInnerHTML={{ __html: syntaxHighlight(jsonString) }} />
          </pre>
        </div>
      );
    };
    
    const ResultCard = ({ data, onReset }) => {
        return (
            <div className="fade-in space-y-6 p-4 sm:p-8 rounded-2xl shadow-lg border" style={{ backgroundColor: 'var(--color-card-background)', borderColor: 'var(--color-border)' }}>
                <div className="flex justify-between items-center pb-4 border-b" style={{ borderColor: 'var(--color-border)' }}>
                    <h2 className="text-2xl font-bold" style={{ color: 'var(--color-heading)' }}>Your Recipe is Ready!</h2>
                    <button onClick={onReset} className="flex items-center gap-2 font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow hover:-translate-y-0.5 bg-[--color-subtle-background] hover:bg-[--color-border]">
                        <SparklesIcon className="w-5 h-5"/> Waffle Again
                    </button>
                </div>

                <div className="space-y-6">
                    <div>
                        <h3 className="text-xl font-bold mb-2" style={{ color: 'var(--color-heading)'}}>Your Waffle:</h3>
                        <p className="p-3 rounded-lg border max-h-48 overflow-y-auto" style={{ backgroundColor: 'var(--color-subtle-background)', borderColor: 'var(--color-border)'}}>{data.metadata.description}</p>
                    </div>
                    
                    <div className="text-sm text-center font-semibold p-2 rounded-lg border" style={{ backgroundColor: 'var(--color-subtle-background)', borderColor: 'var(--color-border)'}}>
                        Prompt cooked for: <span className="font-bold" style={{color: 'var(--color-strawberry-pink)'}}>{data.targetAI}</span>
                    </div>

                    <div>
                        <h3 className="text-xl font-bold mb-2" style={{ color: 'var(--color-heading)'}}>Chef's Notes (Best Practices):</h3>
                        <p className="p-3 rounded-lg border" style={{ backgroundColor: 'var(--color-subtle-background)', borderColor: 'var(--color-border)'}}>{data.best_practices_summary}</p>
                    </div>
                    
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xl font-bold" style={{ color: 'var(--color-heading)'}}>Your Custom-Cooked Prompt</h3>
                            <ActionButton textToCopy={data.prompt} dataToDownload={data} />
                        </div>
                        <JsonDisplay title="Prompt" jsonObject={{ prompt: data.prompt }} />
                    </div>
                </div>
            </div>
        );
    };

    const Loader = () => {
      const loadingMessages = [ "Waffling on it...", "Stirring the batter...", "Preheating the iron...", "Consulting the recipe...", "Adding creativity...", "Getting the syrup ready..." ];
      const [messageIndex, setMessageIndex] = useState(0);
      useEffect(() => {
        const interval = setInterval(() => { setMessageIndex((prev) => (prev + 1) % loadingMessages.length); }, 1800);
        return () => clearInterval(interval);
      }, []);
      return (
        <div className="flex items-center space-x-2">
          <div className="w-3 h-3 rounded-sm animate-active-bounce" style={{ backgroundColor: 'var(--color-strawberry-pink)', animationDelay: '0s' }}></div>
          <div className="w-3 h-3 rounded-sm animate-active-bounce" style={{ backgroundColor: 'var(--color-butter-yellow)', animationDelay: '0.2s' }}></div>
          <div className="w-3 h-3 rounded-sm animate-active-bounce" style={{ backgroundColor: 'var(--color-blueberry-purple)', animationDelay: '0.4s' }}></div>
          <span className="text-sm ml-2 transition-opacity duration-500" style={{ color: 'var(--color-text-secondary)' }}>
            {loadingMessages[messageIndex]}
          </span>
        </div>
      );
    };
    
    const ThemeToggle = ({ theme, onToggle }) => (
      <button onClick={onToggle} className="p-3 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[--color-strawberry-pink]" style={{ backgroundColor: 'var(--color-subtle-background)', color: 'var(--color-heading)', '--ring-offset-color': 'var(--color-background)' }} aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}>
        {theme === 'light' ? <MoonIcon className="w-6 h-6" /> : <SunIcon className="w-6 h-6" />}
      </button>
    );

    const Waveform = () => (
      <div className="flex items-end justify-center gap-1 h-6 w-full" aria-hidden="true">
        {[...Array(5)].map((_, i) => <span key={i} className="w-1 bg-[--color-strawberry-pink] rounded-full animate-waveform" style={{ height: `${Math.random() * 16 + 8}px`, animationDelay: `-${(Math.random() * 0.5).toFixed(2)}s` }}></span>)}
      </div>
    );
    
    const PromptComposer = ({ isLoading, onSubmit, onReset }) => {
        const [inputValue, setInputValue] = useState('');
        const [isListening, setIsListening] = useState(false);
        const [micError, setMicError] = useState('');
        const recognitionRef = useRef(null);
        const interimRef = useRef('');
        
        // Using a ref for isListening to avoid stale closures in recognition event handlers
        const isListeningRef = useRef(isListening);
        isListeningRef.current = isListening;
        
        useEffect(() => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                setMicError("Voice recognition is not supported by this browser.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognitionRef.current = recognition;

            recognition.onresult = (event) => {
                let final_transcript_part = '';
                let current_interim_transcript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript_part += event.results[i][0].transcript;
                    } else {
                        current_interim_transcript += event.results[i][0].transcript;
                    }
                }
                
                setInputValue(prevValue => {
                    let base = prevValue.substring(0, prevValue.length - interimRef.current.length);
                    if (final_transcript_part) {
                        base = (base + final_transcript_part).trim() + ' ';
                    }
                    interimRef.current = current_interim_transcript;
                    return base + current_interim_transcript;
                });
            };

            recognition.onerror = (event) => {
                setMicError(`Mic error: ${event.error}`);
                if (isListeningRef.current) {
                    setIsListening(false);
                }
            };

            recognition.onend = () => {
                interimRef.current = '';
                // If recognition stops but we are still in "listening mode" (e.g., due to a pause), restart it.
                if (isListeningRef.current) {
                    try {
                        recognitionRef.current.start();
                    } catch (err) {
                        console.error("Error restarting speech recognition:", err);
                        setIsListening(false); // Can't restart, so update state to reflect that
                    }
                }
            };

            return () => {
                recognitionRef.current?.abort();
            };
        }, []); // Empty dependency array ensures this runs only once.
        
        const handleMicClick = () => {
            if (!recognitionRef.current || isLoading) return;
            setMicError('');
            const currentlyListening = isListening;
            
            setIsListening(!currentlyListening);

            if (!currentlyListening) {
                setInputValue(prev => prev.trim() ? prev.trim() + ' ' : '');
                try {
                    recognitionRef.current.start();
                } catch(e) {
                    console.error("Error starting recognition:", e);
                    setMicError("Could not start microphone.");
                    setIsListening(false); // Revert state if start fails
                }
            } else {
                recognitionRef.current.stop();
            }
        };
        
        const handleSubmit = (e) => { e.preventDefault(); onSubmit(inputValue); setInputValue(''); };
    
      return (
        <div className="backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-lg border flex flex-col flex-grow fade-in" style={{ backgroundColor: 'var(--color-card-background)', borderColor: 'var(--color-border)'}}>
            <div className="flex justify-between items-center mb-4">
                 <h2 className="text-2xl font-bold" style={{ color: 'var(--color-heading)' }}>What's on your mind?</h2>
                <button onClick={onReset} className="flex items-center gap-2 font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow hover:-translate-y-0.5 bg-[--color-subtle-background] hover:bg-[--color-border] text-sm">
                    <HomeIcon className="w-5 h-5"/> Start Over
                </button>
            </div>
          
            <div className="flex-1 flex flex-col justify-center">
                 <p className="text-center mb-4 text-sm sm:text-base" style={{ color: 'var(--color-text-secondary)' }}>
                    Don't worry about being precise. Just type or talk about your idea, and the Prompt Chef will whip up a professional prompt for you.
                 </p>
            </div>

            <form onSubmit={handleSubmit} className="mt-auto pt-4 border-t" style={{ borderColor: 'var(--color-border)' }}>
                <div className="relative">
                <textarea 
                    value={inputValue} 
                    onChange={(e) => setInputValue(e.target.value)} 
                    onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(e); } }} 
                    placeholder={isLoading ? "The chef is thinking..." : isListening ? "Listening..." : "I want to create an app that helps people find the best waffle toppings..."} 
                    disabled={isLoading} 
                    className={`w-full p-4 pr-32 rounded-xl focus:ring-2 focus:ring-[--color-strawberry-pink] focus:outline-none resize-none shadow-inner border transition-all duration-300 ${isListening ? 'pl-16 ring-2 ring-offset-2 ring-offset-[--color-input-background] ring-[--color-strawberry-pink]' : ''}`} 
                    style={{ backgroundColor: 'var(--color-input-background)', color: 'var(--color-text-primary)', borderColor: 'var(--color-border)' }} 
                    rows={5}
                />
                {isListening && <div className="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none w-12"><Waveform /></div>}
                <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                    <button type="button" onClick={handleMicClick} disabled={isLoading || !recognitionRef.current} className={`p-3 rounded-full transform transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed ${isListening ? 'bg-[--color-strawberry-pink] text-white animate-pulse-mic' : 'bg-[var(--color-button-inactive-bg)] text-[var(--color-button-inactive-text)]'}`} aria-label={isListening ? 'Stop listening' : 'Start listening'}><MicrophoneIcon className="w-6 h-6" /></button>
                    <button type="submit" disabled={isLoading || !inputValue.trim()} className="font-bold py-2 px-6 rounded-lg transition-all duration-300 shadow disabled:opacity-50 disabled:cursor-not-allowed hover:-translate-y-0.5" style={{ backgroundColor: 'var(--color-strawberry-pink)', color: 'white', height: '48px' }}> Cook </button>
                </div>
                </div>
                {micError && <p className="text-xs text-red-500 text-center mt-2">{micError}</p>}
            </form>
        </div>
      );
    };

    const WelcomeScreen = ({ onStart }) => {
        const [targetAI, setTargetAI] = useState('Gemini AI');
        
        return (
            <div className="text-center max-w-3xl mx-auto py-12 px-4 fade-in">
                <h1 className="text-5xl md:text-6xl mb-2" style={{ fontFamily: 'var(--font-display)', color: 'var(--color-heading)' }}>iWaffle</h1>
                <p className="text-lg mb-10" style={{ color: 'var(--color-text-secondary)' }}>Turn your rambles into remarkable prompts. Just waffle on, we'll figure it out.</p>
                
                <div className="p-6 rounded-2xl shadow-lg border space-y-8" style={{ backgroundColor: 'var(--color-card-background)', borderColor: 'var(--color-border)' }}>
                    <div>
                         <h2 className="text-xl font-bold mb-4 text-left" style={{ color: 'var(--color-heading)'}}>1. Optimize Prompt For</h2>
                         <div className="flex bg-[--color-subtle-background] rounded-lg p-1 border" style={{ borderColor: 'var(--color-border)' }}>
                            <button onClick={() => setTargetAI('Gemini AI')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${targetAI === 'Gemini AI' ? 'bg-[--color-butter-yellow] text-black shadow' : 'hover:bg-[--color-input-background]'}`}>Gemini AI</button>
                            <button onClick={() => setTargetAI('ChatGPT-5')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${targetAI === 'ChatGPT-5' ? 'bg-[--color-butter-yellow] text-black shadow' : 'hover:bg-[--color-input-background]'}`}>ChatGPT-5</button>
                         </div>
                    </div>

                    <button onClick={() => onStart({ targetAI })} className="w-full font-bold text-lg py-4 px-8 rounded-lg transition-all duration-300 shadow-lg hover:-translate-y-1 bg-[--color-strawberry-pink] text-white">
                        Start Waffling
                    </button>
                </div>
            </div>
        );
    };

    const ErrorDisplay = ({ data, onReset }) => (
      <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md my-8 fade-in" role="alert">
        <p className="font-bold">{data.message}</p>
        <ul className="mt-2 list-disc list-inside">
          {data.suggestions.map((suggestion, index) => ( <li key={index}>{suggestion}</li> ))}
        </ul>
        <button onClick={onReset} className="mt-4 font-semibold py-2 px-4 rounded-lg bg-red-200 hover:bg-red-300 transition-colors">Try Again</button>
      </div>
    );
    
    //======= MAIN APP COMPONENT =======//
    function App() {
      const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
      const [view, setView] = useState('welcome'); // welcome, composer, result
      const [targetAI, setTargetAI] = useState('Gemini AI');
      const [isLoading, setIsLoading] = useState(false);
      const [appOutput, setAppOutput] = useState(null);
      const [logoAnimationKey, setLogoAnimationKey] = useState(0);
    
      useEffect(() => {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
              console.log('SW registered: ', registration);
            }).catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }
      }, []);

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('theme', theme);
        const themeColorMeta = document.getElementById('theme-color-meta');
        if (themeColorMeta) {
          themeColorMeta.setAttribute('content', theme === 'dark' ? '#1a202c' : '#FFFBF0');
        }
      }, [theme]);
      
      useEffect(() => {
        if (isLoading || view === 'result') { setLogoAnimationKey(prev => prev + 1); }
      }, [isLoading, view]);
    
      const handleThemeToggle = () => setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
    
      const handleReset = () => {
        setAppOutput(null);
        setIsLoading(false);
        setView('welcome');
      };
      
      const handleStart = (config) => {
        setTargetAI(config.targetAI);
        setView('composer');
      };

      const handleComposeSubmit = async (userInput) => {
        if (!userInput.trim()) return;
        setIsLoading(true);
        setAppOutput(null);
        setView('result'); // Switch view immediately to show the loader in the result view
    
        const result = await generatePrompt(userInput, targetAI);
        
        setAppOutput(result.content);
        setIsLoading(false);
      };
    
      const renderContent = () => {
        if (appOutput && appOutput.error) {
            return <ErrorDisplay data={appOutput} onReset={handleReset} />;
        }

        switch (view) {
            case 'welcome': return <WelcomeScreen onStart={handleStart} />;
            case 'composer': return <PromptComposer isLoading={isLoading} onSubmit={handleComposeSubmit} onReset={handleReset} />;
            case 'result':
                if (isLoading) {
                    return (
                        <div className="flex-grow flex flex-col items-center justify-center text-center p-4 fade-in">
                            <Loader />
                            <p className="mt-4 text-lg" style={{ color: 'var(--color-text-secondary)' }}>
                               The chef is tasting your waffle...
                            </p>
                        </div>
                    );
                }
                return appOutput ? <ResultCard data={appOutput} onReset={handleReset} /> : <div className="flex-grow flex items-center justify-center"><Loader/></div>;
            default: return <WelcomeScreen onStart={handleStart} />;
        }
      };
    
      return (
        <div className="min-h-screen font-sans flex flex-col" style={{ backgroundColor: 'var(--color-background)', color: 'var(--color-text-primary)' }}>
          <header className="py-4 px-6 md:px-8 flex justify-between items-center border-b sticky top-0 z-10 backdrop-blur-sm" style={{ borderColor: 'var(--color-border)', backgroundColor: 'rgba(var(--color-background), 0.8)' }}>
            <div className="flex items-center gap-3">
              <LogoIcon key={logoAnimationKey} className="w-20 h-20 animate-jiggle" />
              <h1 className="text-2xl font-bold tracking-tight hidden sm:block" style={{ color: 'var(--color-heading)', fontFamily: 'var(--font-display)'}}>iWaffle</h1>
            </div>
            <ThemeToggle theme={theme} onToggle={handleThemeToggle} />
          </header>
    
          <main className="py-8 px-4 md:px-8 max-w-4xl mx-auto w-full flex-grow flex flex-col">
            {renderContent()}
          </main>
        </div>
      );
    }

    //======= RENDER APPLICATION =======//
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>